#!/bin/bash
BITLOCKER_PARTITION="${1}"

function usage() {
    echo "$(basename ${0}) <partition>"
    echo "Unmounts a previously unlocked bitlocker partition"
}

if [ -z "${BITLOCKER_PARTITION}" ]
then
    echo "Please provide partiton"
    usage
    exit 1
fi

# Make sure the partition exists
if [ ! -e "${BITLOCKER_PARTITION}" ]
then
    echo "File '${BITLOCKER_PARTITION}' does not exist"
    usage
    exit 1
fi

# Make sure it is indeed a block device
if [ ! -b "${BITLOCKER_PARTITION}" ]
then
    echo "File '${BITLOCKER_PARTITION}' is not a block device"
    usage
    exit 1
fi

# Make sure running as root
if [[ ${EUID} > 0 ]]
then
    echo "Please, run as root"
    usage
    exit 1
fi

BITLOCKER_NAME="bitlocker.$(basename ${BITLOCKER_PARTITION})"
BITLOCKER_FILE="/tmp/${BITLOCKER_NAME}"
BITLOCKER_MOUNT="/Volumes/${BITLOCKER_NAME}"

echo "Unmounting the unlocked image from ${BITLOCKER_MOUNT}"
hdiutil detach "${BITLOCKER_MOUNT}"

echo "Unmounting the bitlocker file from ${BITLOCKER_FILE}"
hdiutil detach "${BITLOCKER_FILE}"
