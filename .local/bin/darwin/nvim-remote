#!/bin/bash
socket=$(mktemp /tmp/nvim-socket.XXXXX)
if [ -f $socket ]; then
    rm $socket
fi

__retry() {
    local retries="$1"
    local wait="$2"
    local command="$3"

    $command
    local exit_code=$?
    echo "exit code: $exit_code"

    if [[ $exit_code -ne 0 && $retries -gt 0 ]]; then
        sleep $wait
        __retry $(($retries - 1)) $wait "$command"
    else
        return $exit_code
    fi
}
export -f __retry

parallel --ungroup ::: \
    "kxh $1 +f -L $socket:$socket -- nvim --headless --listen $socket" \
    "__retry 30 1 \"neovide --server $socket\""
rm $socket
