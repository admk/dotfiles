#!/bin/sh

TEMP_FILE=/tmp/kxh-daily-color

daily_color() {
    local COLORS=(
        "#7dcfff" "#73daca" "#b4f9f8" "#9ece6a" "#e0af68"
        "#ff9e64" "#f7768e"
    )
    if [ -z $1 ]; then
        local DAY_OF_WEEK=$(date +%u)
        echo ${COLORS[$DAY_OF_WEEK - 1]}
    elif [ $1 == "random" ]; then
        echo ${COLORS[$((RANDOM % ${#COLORS[@]}))]}
    elif [ ${1:0:1} == "#" ]; then
        echo $1
    else
        echo ${COLORS[$1]}
    fi
}

color_mode() {
    local MODE=$(defaults read -g AppleInterfaceStyle 2>/dev/null)
    if [ -z $MODE ]; then
        echo "light"
    else
        echo "dark"
    fi
}

theme() {
    local MODE=$(color_mode)
    local THEME=${DARK_THEME:-tokyonight_night}
    if [ $MODE == "light" ]; then
        THEME=${LIGHT_THEME:-tokyonight_day}
    fi
    echo $THEME
}


update_aerc() {
    local theme=$(theme)
    local dir=${XDG_CONFIG_HOME}/aerc
    ln -sf \
        ${dir}/stylesets/${theme} \
        ${dir}/stylesets/_active_theme
}


update_alacritty() {
    if [ -z $ALACRITTY_SOCKET ]; then
        return
    fi
    local theme=$(theme)
    local dir=${XDG_CONFIG_HOME}/alacritty
    ln -sf $dir/themes/$theme.toml $dir/_active_theme.toml
    touch $dir/alacritty.toml
}


_kitty_get_colors() {
    kitty @ get-colors | grep "^$1" | tr -s ' ' | cut -d ' ' -f 2
}


update_kitty() {
    if [ -z $KITTY_PID ]; then
        return
    fi
    local COLOR=$1
    local dir=${XDG_CONFIG_HOME}/kitty
    ln -sf $dir/themes/$(theme).conf $dir/_active_theme.conf
    kitty @ set-colors -a -c $dir/_active_theme.conf
    local FG=$(_kitty_get_colors foreground)
    local AFG
    if [ $2 == "dark" ]; then
        AFG=$(_kitty_get_colors background)
    else
        AFG=$(_kitty_get_colors foreground)
    fi
    KITTY_COLORS=(
        active_tab_foreground=$AFG
        active_tab_background=$COLOR
        inactive_tab_foreground=$FG
    )
    kitty @ set-colors -a -c ${KITTY_COLORS[@]}
}


update_sioyek() {
    # TODO: no tokyonight theme
    # TODO: cli activation
    local dir=$XDG_CONFIG_HOME/sioyek
    ln -sf $dir/themes/$(theme).toml $dir/_active_theme.toml
}


update_sketchybar() {
    touch $XDG_CONFIG_HOME/sketchybar/sketchybarrc
}


update_yabai() {
    yabai -m config insert_feedback_color "0xe0${1:2}"
}


COLOR=$(daily_color $1)
MODE=$(color_mode)
if [ ! -z $COLOR ]; then
    if [ -f $TEMP_FILE ] && [ $(cat $TEMP_FILE) == "$MODE:$COLOR" ]; then
        # echo "Color already set"
        echo "$MODE:$COLOR"
        exit 0
    fi
    echo "$MODE:$COLOR" | tee $TEMP_FILE
    echo "export DAILY_COLOR=$(daily_color $1)" > $TEMP_FILE.sh
    update_aerc
    update_alacritty
    update_kitty $COLOR $MODE
    update_sioyek
    update_sketchybar
    update_yabai $COLOR $MODE
else
    echo "Error: Invalid color"
    exit 1
fi
