#!/usr/bin/env xonsh
gitdir = '~/.kodot'
if pf'{gitdir}'.exists():
    cd @(gitdir)
    git pull --force origin master 2>&1 > /dev/null
    cd -
else:
    git clone ~ .kodot 2>&1 > /dev/null

ssh_host, ssh_args = [], []
for a in $ARGS[1:]:
    if a.startswith("-"):
        ssh_args.append(a)
    else:
        ssh_host.append(a)
if len(ssh_host) != 1:
    raise ValueError("Invalid arguments.")
ssh_host = ssh_host[0]
rsh = f"ssh {' '.join(ssh_args)}"
rsync \
    --archive --compress --update --human-readable --partial \
    --progress --rsh=@(rsh) --cvs-exclude \
    f"{gitdir}/" f"{ssh_host}:.kodot"
ssh @(ssh_host) @(ssh_args) \
    -o RequestTTY=yes \
    @("bash -c '.kodot/.config/xonsh/as_default.sh'")
