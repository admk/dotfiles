#!/usr/bin/env xonsh
gitdir = '~/.kodot'
if pf'{gitdir}'.exists():
    cd @(gitdir)
    git pull origin master
    cd -
else:
    git clone ~ .kodot

ssh_host, ssh_args = [], []
for a in $ARGS[1:]:
    if a.startswith("-"):
        ssh_args.append(a)
    else:
        ssh_host.append(a)
if len(ssh_host) != 1:
    raise ValueError("Invalid arguments.")
ssh_host = ssh_host[0]
rsync \
    --archive --compress --update \
    --human-readable --partial --progress \
    f"{gitdir}/" f"{ssh_host}:.kodot"
ssh @(ssh_host) @(ssh_args) \
    -o RequestTTY=yes \
    @("HOME=$HOME/.kodot bash -l -c '~/.config/xonsh/as_default.sh'")
